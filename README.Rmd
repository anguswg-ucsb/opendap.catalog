---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  eval = TRUE
)
```

# opendap.catalog

<!-- badges: start -->
[![Dependencies](https://img.shields.io/badge/dependencies-7/33-orange?style=flat)](#)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://choosealicense.com/licenses/mit/)
[![Website deployment](https://github.com/mikejohnson51/opendap.catalog/actions/workflows/pkgdown.yaml/badge.svg)](https://github.com/mikejohnson51/opendap.catalog/actions/workflows/pkgdown.yaml)
[![LifeCycle](man/figures/lifecycle/lifecycle-experimental.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
[![R CMD Check](https://github.com/mikejohnson51/opendap.catalog/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/mikejohnson51/opendap.catalog/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

# TL:DR;

`opendapR` provides a generalized inter functions needed to find, and document, the information needed to identify and form OpenDap queries for a range of resources.

## Terminolgy

OPeNDAP is a framework that simplifies scientific data networking via software that makes local data accessible to remote locations. [see here](https://www.opendap.org)

For example a large NetCDF file of gridmet data can sit on the Northwestern computing system and users - like us - can request subsets of data from that file!

Large local files can be published to a web-based **T**HREDDS **D**ata **S**erver from which metadata and data can be accessed using OPeNDAP, OGC WCS, HTTP, and other data access protocols.

This allows users to stream the portion of the data set releavnat to them!

## OpenDap Syntax

To request a subset from a TDS data using OpenDAP protocol, a common form can be followed:

```
URL?{varname}{Ymin:1:Ymax}{Xmin:1:Xmax}{Tmin:1:Tmax}
```

# Use Cases

Lets get data in some different ways for the state of Florida.

```{r}
library(opendap.catalog)
library(terra)

AOI <- AOI::aoi_get(state = "FL", county = "all")
plot(AOI$geometry)
```      

### Remote Resource

```{r}
url <- "https://cida.usgs.gov/thredds/dodsC/bcsd_obs"

dap = dap_crop(URL = url, AOI = AOI, startDate = "1995-01-01")

dap.summary(dap)

bcsd = dap_get(dap = dap[dap$varname == "pr",])

plot(bcsd$pr)
```

## Local Resource

```{r}
url <- '/Users/mjohnson/Downloads/NEXGDM_srad_2020_v100.nc'
utils:::format.object_size(file.size(url), "auto")

system.time({
  dap = dap_crop(URL = url, AOI = AOI, 
                 startDate = "2020-01-01", endDate = "2020-01-05")
  nexgdm = dap_get(dap)
})

dap.summary(dap)

plot(nexgdm$srad)
```

## Remote Spatially tiled reosouces
### MODIS 

```{r}
ref = readRDS('src/modis_map.rds') |>
  dplyr::filter(id == 'mod16', variable == 'PET_500m') |> 
  dplyr::mutate(tiled = "XY")

nrow(ref) # tiles

system.time({
  dap = dap_crop(catolog = ref, AOI = AOI::aoi_get(state = "FL"),
                 startDate = "2020-01-01", endDate = "2020-01-15")
  
  mod = dap_get(dap)
})

dap.summary(dap)
terra::plot(mod)
```
## Remote Temportally tiled reources

...

### LOCA

...


## NGEN focus?
### January ET for Florida counties

```{r}
ref = readRDS('src/modis_map.rds') |>
  dplyr::filter(id == 'mod16', variable == 'ET_500m') |> 
  dplyr::mutate(tiled = "XY")

AOI = AOI::aoi_get(state = "FL", county = 'all')

system.time({
  dap = dap_crop(catolog = ref, AOI = AOI,
                 startDate = "2020-01-01", endDate = "2020-01-31")
  
  mod = dap_get(dap)
})

system.time({
 agg = zonal::execute_zonal(mod, AOI, "geoid")
})

plot(agg[grep("V", names(agg))])

aggMax = zonal::execute_zonal(mod, AOI, "geoid", FUN = "max")

plot(aggMax[grep("V", names(aggMax))])

```

